#!/usr/bin/env bash
# Episodes
# By daoo

# TODO: custom command
command="mplayer"
state_file="./.episodes-state"

function print_help() {
  echo "n - next file"
  echo "q - remove and quit"
  echo "u - keep and quit"
}

function init() {
  if [[ -f "$state_file" ]]; then
    echo "Already initialized."
    exit 1
  else
    echo "Initializing..."
    ls > $state_file

    echo "Found $(cat $state_file | wc -l) file(s)"

    echo "Done"
    exit 0
  fi
}

function uninit() {
  if [[ -f "$state_file" ]]; then
    echo "Okay."
    rm $state_file
    exit 0
  else
    echo "Not initialized"
    exit 0
  fi
}

function remove() {
  sed -i 1d $state_file
}

case "$1" in
  --init)   init ;;
  --uninit) uninit ;;
esac

if [[ -f "$state_file" ]]; then
  # Backup and get state
  cp $state_file $state_file.bak

  quit=0
  while [[ ($quit -ne 1) && (-s $state_file) ]]; do
    file=$(head -n1 $state_file)

    echo "$file"
    if $command "$file" &> /dev/null; then
      echo -n "Remove file from state [n,q,u,?]? "

      inp=""
      read inp

      case "$inp" in
        'n') remove ;;
        'u') quit=1 ;;
        'q') remove; quit=1 ;;
        '?') print_help ;;
      esac
    fi
  done
else
  echo "Directory need to be initialized."
  echo "Run episodes --init"
fi
