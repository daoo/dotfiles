#!/usr/bin/env ruby

GIT_FORMAT="%C(yellow)%ar%Creset %C(blue)(%ae)%Creset %s"

TEXT_RESET       = "\e[0m"
TEXT_RED         = "\e[0;31m"
TEXT_PURPLE      = "\e[0;35m"
TEXT_YELLOW_BOLD = "\e[1;33m"

def puts_color(color, str)
  puts "#{color}#{str}#{TEXT_RESET}"
end

def git_fetch(repo)
  return system("git --git-dir=\"#{repo}\" fetch --quiet")
end

def git_rev_parse(repo, commit_id)
  return `git --git-dir="#{repo}" rev-parse #{commit_id}`.chomp()
end

def git_log(repo, from, to)
  return `git --git-dir="#{repo}" log --format=format:"#{GIT_FORMAT}" #{from}..#{to}`
end

interactive = false
case ARGV[0]
  when "-i", "--interactive"
    interactive = true
end

File.open("#{ENV["HOME"]}/.git-repos") do |f|
  while (line = f.gets)
    repo = line.chomp
    puts_color(TEXT_PURPLE, "Syncing #{repo}")

    dir     = File.join(ENV["HOME"], repo)
    git_dir = File.join(dir, ".git/")

    if not git_fetch(git_dir)
      puts_color(TEXT_RED, "Error while running fetch")
      exit 1
    end

    new_commits = git_log(git_dir, "master", "origin/master")
    if not new_commits.empty?
      puts "  New commits:"
      new_commits.each_line do |line|
        puts "    #{line}"
      end

      if interactive
        puts_color(TEXT_YELLOW_BOLD, "Fetch resulted in new HEAD")
        puts_color(TEXT_YELLOW_BOLD, "Opening #{ENV["SHELL"]} in #{dir}")
        system("cd #{dir} && #{ENV['SHELL']}")
      end
    end
  end
end
