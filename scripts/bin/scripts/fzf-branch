#!/usr/bin/env python3

import subprocess
import sys


def main(gitopts):
    git_command = ["git", "branch", "--color=always", "-vv"] + gitopts
    fzf_command = ["fzf", "--ansi", "--no-sort", "--expect=enter,ctrl-s,ctrl-d,ctrl-o"]
    git = subprocess.Popen(git_command, stdout=subprocess.PIPE)
    fzf = subprocess.run(fzf_command, stdin=git.stdout, stdout=subprocess.PIPE)
    git.wait()

    output = fzf.stdout.splitlines()
    if fzf.returncode == 0 and len(output) == 2:
        key = output[0]
        branch = output[1][2:].split()[0].decode("UTF-8")

        if key == b"enter":
            subprocess.run(["git", "checkout", branch])
        elif key == b"ctrl-d":
            subprocess.run(["git", "branch", "-d", branch])
        elif key == b"ctrl-p":
            sys.stdout.write(branch + "\n")
        elif key == b"ctrl-s":
            subprocess.run(["git", "show", branch])

main(sys.argv[1:])
