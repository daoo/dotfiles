#!/usr/bin/env bash
# Utility to generate a list of all files that are not part of a package
# Author: Spider.007 / Sjon

read -r -d '' filter <<'EOF'
/boot/grub
/boot/initramfs-*
/boot/syslinux
/etc/X11/xdm/authdir
/etc/ca-certificates
/etc/ssl
/var/abs
/var/cache
/var/games
/var/lib/mysql
/var/lib/pacman
/var/log
/var/lib/texmf
/var/run
/var/spool/cups
/var/tmp
EOF

filter="$(echo "$filter" | tr '\n' '|')"
filter="${filter%|}"

tmpdir="$(mktemp -d)"
cd "$tmpdir" || exit 1
find /bin /boot /etc /lib /opt /sbin /usr /var | sort -u > full
pacman -Ql | tee owned_full | cut -d' ' -f2- | sed 's/\/$//' | sort -u > owned

grep -Ev "^($filter)" owned > owned- && mv owned- owned

echo -e '\033[1mOwned, but not found:\033[0m'
comm -13 full owned | while read -r entry
do
  echo ["$(grep --max-count=1 "$entry" owned_full|cut -d' ' -f1)"] "$entry"
done | sort

grep -Ev "^($filter)" full > full- && mv full- full

echo -e '\n\033[1mFound, but not owned:\033[0m'
comm -23 full owned

rm -rf "$tmpdir"
