#!/usr/bin/env python

import os
import subprocess
import sys
import tempfile

def yield_paths(start_path, recursive=False):
    for root, dirs, files in os.walk(start_path):
        file_paths = [os.path.join(root, path) for path in files]
        dir_paths = [os.path.join(root, path) for path in dirs]
        for path in sorted(file_paths + dir_paths):
            yield os.path.relpath(path, start_path)

        if not recursive:
            dirs.clear()

def interact(editor, old_paths):
    fwrite = tempfile.NamedTemporaryFile(mode='w', delete=False)
    path = fwrite.name
    fwrite.write("\n".join(old_paths))
    fwrite.close()

    subprocess.call([editor, path])

    fread = open(path, 'r')
    new_paths = fread.read().splitlines()
    fread.close()

    os.remove(path)
    return new_paths

def rename(old_names, new_names):
    assert len(old_names) == len(new_names)
    for old, new in zip(old_names, new_names):
        # Don't rename if the name is unchanged
        if old != new:
            sys.stdout.write("Moving \"%s\" to \"%s\".\n" % (old, new))
            if not os.path.exists(new):
                os.rename(old, new)
            else:
                sys.stderr.write("Warning: file %s already exists.\n" % new)

def main(editor, recursive, path):
    old_names = list(yield_paths(path, recursive))
    new_names = interact(editor, old_names)

    if len(new_names) == 0:
        sys.stderr.write("Aborting rename due to empty input\n")
        return 1

    if len(new_names) != len(old_names):
        sys.stderr.write("Error: number of lines have changed, exiting.\n")
        return 1

    rename(old_names, new_names)

def print_help(prog, file):
    file.write("Usage: %s [-h|--help] [-r|--recursive] [PATH]\n" % prog)

def parse_args(argv):
    editor = os.getenv("EDITOR", default="vim")
    recursive = False
    path = os.getcwd()

    if len(argv) > 1:
        for arg in argv[1:]:
            if arg == "-r" or arg == "--recursive":
                recursive = True
            elif arg == "-h" or arg == "--help":
                print_help(argv[0], sys.stdout)
                sys.exit(0)
            else:
                path = os.path.abspath(arg)

    return (editor, recursive, path)

sys.exit(main(*parse_args(sys.argv)))
