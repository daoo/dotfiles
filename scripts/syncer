#!/usr/bin/env ruby

require 'tempfile'

def main(argv)
  if argv.length < 2
    puts "Usage: syncer [OPTIONS] INFILE OUTDIR"
    puts "Options:"
    exit 0
  end

  # Get infile and outdir
  outdir = argv.pop.chomp
  infile = argv.pop.chomp

  if not File.exists?(infile)
    puts "File #{infile} does not exist"
    exit 1
  end

  if not Dir.exist?(outdir)
    puts "Directory #{outdir} does not exist"
    exit 1
  end

  lines = []
  File.open(infile) do |f|
    lines = f.readlines()
  end

  lines.collect! { |l| l.split(File::SEPARATOR) }
  common = lines.first
  lines.each do |line|
    common = common & line
  end

  source_dir = common.join(File::SEPARATOR)

  Tempfile.open('random') do |tf|
    lines.each do |line|
      file = (line - common).join(File::SEPARATOR)
      tf.puts file
    end

    system("rsync --progress --stats --delete --ignore-existing --files-from='#{tf.path}' '#{source_dir}' '#{outdir}'")
  end
end

main(ARGV)

# vim: set fdm=marker :
