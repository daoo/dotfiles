#!/usr/bin/env bash

set -e

if [[ -d ".cabal-sandbox" ]]; then
  dbflag="-package-db=$(echo .cabal-sandbox/*-packages.conf.d)"
else
  dbflag=""
fi

tmpdir="$(mktemp -d)"
tmpfile="$(mktemp -p "$tmpdir" core-XXX.hs)"

${GHC:-ghc} \
  -o "$tmpdir/main" \
  -outputdir "$tmpdir" \
  -isrc \
  "$dbflag" \
  -fforce-recomp \
  -dsuppress-coercions \
  -dsuppress-module-prefixes \
  -dsuppress-uniques \
  -dsuppress-idinfo \
  -dsuppress-type-applications \
  -dppr-cols270 \
  -dppr-case-as-let \
  "-ddump-${TYPE-simpl}" \
  "$@" \
  > "$tmpfile"

sed -i '/^\(\$fShow\|\$w\$cshows\)/,/^$/d' "$tmpfile"

${EDITOR:-nvim} "$tmpfile"

rm -rf "$tmpdir"
