#!/usr/bin/env bash

md5sum_dir() {
  tar c "$1" | md5sum | cut -d ' ' -f 1
}

# Check for atool
if ! which atool &> /dev/null; then
  echo "atool not found" >&2
  exit 1
fi

# Check parameters
file="$1"

if [[ -a "$file" ]]; then
  # Some basic information about the archive
  name="$(basename "$file")"
  archive="$(readlink -f "$file")"
  old_pwd="$PWD"

  # Extract to a tmp dir
  echo "Extracting..."
  working_dir="$(mktemp -d "/tmp/aedit-XXXXXXXX")"
  atool --extract-to="$working_dir" "$file" > /dev/null

  old_checksum="$(md5sum_dir "$working_dir")"

  # Start a new shell in the tmp directory
  echo "Launching shell..."
  cd "$working_dir"
  "$SHELL"

  new_checksum="$(md5sum_dir "$working_dir")"

  if [[ $old_checksum = $new_checksum ]]; then
    echo "No changes, not repacking."
  else
    echo "Repacking..."

    # Make backup
    backupfile="$(mktemp "/tmp/$name-XXXXXXXX")"
    mv "$archive" "$backupfile"

    atool -a -f "$archive" $(ls -b "$working_dir") > /dev/null
  fi

  echo "Done."
  rm -r "$working_dir"
  cd "$old_pwd"
else
  echo "File '$file' does not exist." >&2
fi
