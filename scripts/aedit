#!/bin/bash

rnd() {
  echo `</dev/urandom tr -dc A-Za-z0-9 | head -c16`
}

# Check for atool
ATOOL="$(which atool)"
if [ $? -ne 0 ]; then
  echo "atool not found"
  exit 1
fi

# Check parameters
FILE="$@"
REPACK=1

if [ -a "$FILE" ]; then
  # Some basic information about the archive
  NAME="$(basename "$FILE")"
  ARCHIVE=$(readlink -f "$FILE")
  DIR="$(dirname "$(readlink -f "$FILE")")"

  echo "Extracting..."
  # Extract to a tmp dir
  TMPDIR=`mktemp -d "/tmp/aedit-XXXXXXXX"`
  $ATOOL --extract-to=$TMPDIR "$@"

  echo "Launching shell..."
  # Start a new shell in the tmp directory
  cd "$TMPDIR"
  $SHELL

  if [ $REPACK ]; then
    echo "Repacking..."
    mv "$ARCHIVE" "/tmp/$NAME.`rnd`" # Backup
    $ATOOL -a -f "$ARCHIVE" $(ls -b $TMPDIR)
  fi

  echo "Done."
  rm -r "$TMPDIR"
  cd "$DIR"
else
  echo "File '$FILE' does not exist."
fi
